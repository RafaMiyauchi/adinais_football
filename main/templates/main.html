{% extends 'base.html' %}
{% load static %}

{% block title %}
    Adinais Football - The Pitch
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-12 animate-fade-in-up">
        <h1 class="font-orbitron text-5xl font-black text-white tracking-wide">THE ARSENAL</h1>
        <p class="text-brand-light-gray mt-2 text-lg">Browse our elite collection of football gear.</p>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-8 animate-fade-in-up" style="animation-delay: 100ms;">
        <div class="flex space-x-2 border border-gray-700 rounded-lg p-1 mb-4 md:mb-0">
            </div>
        {% if user.is_authenticated %}
        <button id="add-product-btn" class="bg-brand-accent-lime hover:bg-opacity-90 text-brand-deep-blue font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 flex items-center space-x-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span>Add New Product</span>
        </button>
        {% endif %}
    </div>

    <div id="loading-spinner" class="text-center py-20">
        <svg class="w-16 h-16 mx-auto text-brand-accent-lime animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg text-gray-400">Loading Arsenal...</p>
    </div>

    <div id="error-state" class="hidden text-center py-20">
        <h2 class="text-3xl font-orbitron font-bold text-red-400 mt-6">CONNECTION FAILED</h2>
        <p class="text-gray-500 mt-2">Could not fetch products. Please try again later.</p>
    </div>
    
    <div id="empty-state" class="hidden col-span-full text-center py-20">
        <svg class="w-40 h-40 mx-auto text-gray-700 drop-shadow-[0_0_10px_rgba(163,255,0,0.5)]" viewBox="0 0 24 24" fill="none" stroke="#A3FF00" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10" fill="#161B22"></circle>
          <path d="M12 2a10 10 0 0 0-4.47 1.23l2.83 5.66 4.47-1.23L12 2z"></path>
          <path d="M3.23 9.53l5.66 2.83-1.23 4.47-5.66-2.83 1.23-4.47z"></path>
          <path d="M20.77 9.53l-5.66 2.83 1.23 4.47 5.66-2.83-1.23-4.47z"></path>
          <path d="M12 22a10 10 0 0 0 4.47-1.23l-2.83-5.66-4.47 1.23L12 22z"></path>
          <path d="M8.89 8.89l-1.23 4.47 4.47 1.23 1.23-4.47-4.47-1.23z"></path>
        </svg>
        <h2 class="text-3xl font-orbitron font-bold text-gray-400 mt-6">THE PITCH IS EMPTY</h2>
        <p class="text-gray-500 mt-2">No products found. Be the first to add something to the arsenal.</p>
    </div>

    <div id="product-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        </div>
</div>

<div id="quick-view-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
    <div id="modal-content" class="glassmorphism rounded-2xl shadow-2xl w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden transform scale-95 transition-transform duration-300">
        <img id="modal-img" src="" alt="Product Image" class="w-full h-full object-cover">
        <div class="p-8 flex flex-col">
            <div>
                <p id="modal-category" class="font-semibold text-brand-accent-lime mb-1"></p>
                <h2 id="modal-name" class="font-orbitron text-3xl font-bold text-white"></h2>
                <p id="modal-brand" class="text-gray-400 text-lg mb-4"></p>
                <p id="modal-price" class="text-brand-accent-lime text-4xl font-bold mb-4"></p>
                <p id="modal-description" class="text-brand-light-gray mb-6 h-24 overflow-y-auto"></p>
            </div>
            <div class="grid grid-cols-2 gap-4 text-center mt-auto">
                 <div class="bg-brand-space-gray p-4 rounded-xl">
                    <p class="text-sm text-gray-400">Rating</p>
                    <p id="modal-rating" class="text-xl font-bold text-white flex items-center justify-center space-x-1"></p>
                </div>
                <div class="bg-brand-space-gray p-4 rounded-xl">
                    <p class="text-sm text-gray-400">Stock</p>
                    <p id="modal-stock" class="text-xl font-bold text-green-400"></p>
                </div>
            </div>
            <a id="modal-link" href="#" class="w-full text-center bg-brand-accent-lime hover:bg-opacity-90 text-brand-deep-blue font-bold py-3 mt-6 rounded-lg transition duration-300">View Full Details</a>
        </div>
        <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('product-grid');
    const spinner = document.getElementById('loading-spinner');
    const emptyState = document.getElementById('empty-state');
    const errorState = document.getElementById('error-state');
    const addProductBtn = document.getElementById('add-product-btn');
    const currentUserId = "{{ user.id|default_if_none:'' }}";

    function setUIState(state) {
        spinner.classList.toggle('hidden', state !== 'loading');
        grid.classList.toggle('hidden', state !== 'grid');
        emptyState.classList.toggle('hidden', state !== 'empty');
        errorState.classList.toggle('hidden', state !== 'error');
    }

    function buildProductCard(product) {
        // Sanitize data with DOMPurify to prevent XSS attacks
        const name = DOMPurify.sanitize(product.name);
        const brand = DOMPurify.sanitize(product.brand);
        const category = DOMPurify.sanitize(product.category);
        const price = DOMPurify.sanitize(product.price);
        const rating = DOMPurify.sanitize(product.rating);
        const stock = DOMPurify.sanitize(product.stock);
        const description = DOMPurify.sanitize(product.description);
        const thumbnail = DOMPurify.sanitize(product.thumbnail);
        
        let actionButtons = '';
        if (currentUserId && Number(product.user_id) === Number(currentUserId)) {
            actionButtons = `
                <button class="edit-btn text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Edit</button>
                <button class="delete-btn text-center bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Delete</button>
            `;
        }
        
        return `
        <div class="product-card group relative bg-brand-space-gray rounded-2xl shadow-lg overflow-hidden border border-transparent hover:border-brand-accent-lime transition-all duration-300"
            data-id="${product.id}"
            data-name="${name}"
            data-brand="${brand}"
            data-category="${category}"
            data-price="${price}"
            data-rating="${rating}"
            data-stock="${stock}"
            data-description="${description}"
            data-thumbnail="${thumbnail}"
            data-url="/products/${product.id}/"
        >
            <div class="absolute top-4 right-4 z-10 bg-brand-deep-blue bg-opacity-70 px-3 py-1 rounded-full text-xs font-bold text-brand-accent-lime">${category}</div>
            <img src="${thumbnail}" class="w-full h-64 object-cover group-hover:scale-110 transition-transform duration-500" alt="${name}">
            <div class="p-5">
                <h2 class="text-xl font-bold font-orbitron text-white truncate">${name}</h2>
                <p class="text-gray-400 text-sm mb-3">${brand}</p>
                <div class="flex justify-between items-center mb-4">
                    <p class="text-brand-accent-lime font-bold text-2xl">Rp${price}</p>
                    <div class="flex items-center space-x-1">
                        <span class="text-yellow-400">‚≠ê</span>
                        <span class="text-white font-semibold">${rating}</span>
                    </div>
                </div>
                 <div class="flex justify-between items-center space-x-2">
                    <button class="quick-view-btn flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Quick View</button>
                    ${actionButtons}
                </div>
            </div>
        </div>
        `;
    }

    async function fetchProducts() {
        setUIState('loading');
        try {
            const response = await fetch("{% url 'main:show_json' %}");
            if (!response.ok) throw new Error('Network response was not ok');
            const products = await response.json();

            grid.innerHTML = '';
            if (products.length === 0) {
                setUIState('empty');
            } else {
                products.forEach(product => {
                    grid.innerHTML += buildProductCard(product);
                });
                setUIState('grid');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            setUIState('error');
        }
    }

    function populateModalForm(product = {}) {
        const container = document.getElementById('form-fields-container');
        container.innerHTML = `
            <input type="hidden" name="id" value="${product.id || ''}">
            <div class="relative"><input type="text" name="name" placeholder="Product Name" class="w-full p-4 form-input rounded-lg" required value="${DOMPurify.sanitize(product.name || '')}"><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Name</label></div>
            <div class="relative"><input type="number" name="price" placeholder="Price" class="w-full p-4 form-input rounded-lg" required value="${DOMPurify.sanitize(product.price || '')}"><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Price</label></div>
            <div class="relative"><textarea name="description" placeholder="Description" rows="4" class="w-full p-4 form-input rounded-lg" required>${DOMPurify.sanitize(product.description || '')}</textarea><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Description</label></div>
            <div class="relative"><input type="url" name="thumbnail" placeholder="Thumbnail URL" class="w-full p-4 form-input rounded-lg" required value="${DOMPurify.sanitize(product.thumbnail || '')}"><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Thumbnail URL</label></div>
            <div class="relative"><input type="text" name="category" placeholder="Category" class="w-full p-4 form-input rounded-lg" required value="${DOMPurify.sanitize(product.category || '')}"><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Category</label></div>
            <div class="relative"><input type="number" name="stock" placeholder="Stock" class="w-full p-4 form-input rounded-lg" required value="${DOMPurify.sanitize(product.stock || '')}"><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Stock</label></div>
            <div class="relative"><input type="text" name="brand" placeholder="Brand" class="w-full p-4 form-input rounded-lg" required value="${DOMPurify.sanitize(product.brand || '')}"><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Brand</label></div>
            <div class="relative"><input type="number" step="0.1" name="rating" placeholder="Rating" class="w-full p-4 form-input rounded-lg" required value="${DOMPurify.sanitize(product.rating || '')}"><label class="absolute left-4 -top-2.5 text-xs text-gray-400 bg-brand-space-gray px-1">Rating</label></div>
        `;
    }

    async function handleFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const productId = formData.get('id');
        
        const url = productId ? `/edit-product-ajax/${productId}/` : "{% url 'main:add_product_ajax' %}";
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();
            if (response.ok) {
                hideModal();
                showToast(result.message, 'success');
                fetchProducts(); // Refresh the product list
            } else {
                // Handle form errors from the server
                const errorMsg = result.message || Object.values(result.errors).flat().join(' ');
                showToast(errorMsg, 'error');
            }
        } catch (error) {
            console.error('Submit error:', error);
            showToast('An unexpected error occurred.', 'error');
        }
    }
    
    if (addProductBtn) {
        addProductBtn.addEventListener('click', () => {
            document.getElementById('modal-title').textContent = 'Add to Arsenal';
            populateModalForm();
            document.getElementById('product-form').onsubmit = handleFormSubmit;
            showModal();
        });
    }

    grid.addEventListener('click', async (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');

        if (editBtn) {
            const card = editBtn.closest('.product-card');
            const productId = card.dataset.id;
            try {
                const response = await fetch(`/get-product/${productId}/`);
                const product = await response.json();
                document.getElementById('modal-title').textContent = 'Refine Gear';
                populateModalForm(product);
                document.getElementById('product-form').onsubmit = handleFormSubmit;
                showModal();
            } catch (error) {
                showToast('Failed to fetch product details.', 'error');
            }
        }

        if (deleteBtn) {
            const card = deleteBtn.closest('.product-card');
            const productId = card.dataset.id;
            if (confirm(`Are you sure you want to delete "${card.dataset.name}"?`)) {
                try {
                    const response = await fetch(`/delete-product-ajax/${productId}/`, {
                        method: 'POST',
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showToast(result.message, 'success');
                        fetchProducts();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                     showToast('An error occurred during deletion.', 'error');
                }
            }
        }
    });

    // Initial fetch to load products when the page loads
    fetchProducts();
});
</script>
{% endblock scripts %}